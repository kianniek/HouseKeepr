<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Household Agenda</title>
  <link rel="stylesheet" href="calendar.css" />
</head>
<body>
  <noscript>This application requires JavaScript.</noscript>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="calendar.js"></script>

  <script>
    const { useState, useEffect } = React;

    function useCurrentTime() {
      const [now, setNow] = useState(null);
      useEffect(() => {
        let offset = 0;
        async function load() {
          try {
            const resp = await fetch('https://worldtimeapi.org/api/ip');
            const data = await resp.json();
            const apiTime = new Date(data.datetime);
            offset = apiTime.getTime() - Date.now();
            setNow(new Date(Date.now() + offset));
          } catch (err) {
            console.error('Failed to fetch time', err);
            setNow(new Date());
          }
        }
        load();
        const timer = setInterval(() => {
          setNow(new Date(Date.now() + offset));
        }, 60000);
        return () => clearInterval(timer);
      }, []);
      return now;
    }


    function CalendarMonth({ events, date }) {
      const year = date.getFullYear();
      const month = date.getMonth();

      const eventsByDay = window.groupEventsByDay(events);

      const monthStart = new Date(year, month, 1);
      const monthEnd = new Date(year, month + 1, 0);
      const firstDay = monthStart.getDay();
      const totalCells = Math.ceil((firstDay + monthEnd.getDate()) / 7) * 7;

      const cells = [];
      for (let i = 0; i < totalCells; i++) {
        const date = new Date(year, month, i - firstDay + 1);
        const key = date.toISOString().slice(0, 10);
        const dayEvents = eventsByDay[key] || [];
        cells.push(React.createElement('div', { className: 'cell', key: key },
          React.createElement('div', { className: 'date' }, date.getDate()),
          React.createElement('ul', null,
            dayEvents.map((ev, idx) => React.createElement('li', { key: idx }, ev.summary))
          )
        ));
      }

      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d =>
        React.createElement('div', { className: 'cell header', key: d }, d)
      );

      return React.createElement('div', { className: 'calendar' },
        dayHeaders.concat(cells)
      );
    }

    function CalendarWeek({ events, date, currentTime }) {
      const eventsByDay = window.groupEventsByDay(events);
      const start = new Date(date);
      start.setDate(start.getDate() - start.getDay());

      const dayCols = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(start);
        d.setDate(start.getDate() + i);
        const key = d.toISOString().slice(0, 10);
        const dayEvents = eventsByDay[key] || [];
        const slots = [];
        for (let s = 0; s < 48; s++) {
          slots.push(React.createElement('div', { className: 'time-slot', key: s }));
        }
        const lineTop = currentTime && currentTime.toDateString() === d.toDateString()
          ? ((currentTime.getHours() * 60 + currentTime.getMinutes()) / 30) * 20
          : null;
        dayCols.push(React.createElement('div', { className: 'day-column', key: key },
          lineTop != null && React.createElement('div', { className: 'current-time-line', style: { top: lineTop + 'px' } }),
          slots,
          React.createElement('ul', null,
            dayEvents.map((ev, idx) => React.createElement('li', { key: idx }, ev.summary))
          )
        ));
      }

      const timeSlots = [];
      for (let i = 0; i < 48; i++) {
        const label = `${String(Math.floor(i / 2)).padStart(2, '0')}:${i % 2 ? '30' : '00'}`;
        timeSlots.push(React.createElement('div', { className: 'time-slot', key: i }, label));
      }

      return React.createElement('div', { className: 'week-grid' },
        React.createElement('div', { className: 'time-column' }, timeSlots),
        dayCols
      );
    }

    function CalendarDay({ events, date, currentTime }) {
      const eventsByDay = window.groupEventsByDay(events);
      const key = date.toISOString().slice(0, 10);
      const dayEvents = eventsByDay[key] || [];
      const slots = [];
      for (let i = 0; i < 48; i++) {
        const label = `${String(Math.floor(i / 2)).padStart(2, '0')}:${i % 2 ? '30' : '00'}`;
        slots.push(React.createElement('div', { className: 'time-slot', key: i }, label));
      }
      const lineTop = currentTime && currentTime.toDateString() === date.toDateString()
        ? ((currentTime.getHours() * 60 + currentTime.getMinutes()) / 30) * 20
        : null;
      return React.createElement('div', { className: 'day-grid' },
        React.createElement('div', { className: 'time-column' }, slots),
        React.createElement('div', { className: 'day-column' },
          lineTop != null && React.createElement('div', { className: 'current-time-line', style: { top: lineTop + 'px' } }),
          React.createElement('ul', null,
            dayEvents.map((ev, idx) => React.createElement('li', { key: idx }, ev.summary))
          )
        )
      );
    }

    function CalendarYear({ events, date }) {
      const year = date.getFullYear();
      const months = [];
      for (let m = 0; m < 12; m++) {
        const d = new Date(year, m, 1);
        months.push(React.createElement('div', { className: 'month', key: m },
          d.toLocaleString('default', { month: 'long' })
        ));
      }
      return React.createElement('div', { className: 'year-view' }, months);
    }

    function Calendar({ events }) {
      const [view, setView] = useState('month');
      const [date, setDate] = useState(new Date());
      const currentTime = useCurrentTime();

      function navigate(delta) {
        setDate(prev => {
          const d = new Date(prev);
          if (view === 'day') {
            d.setDate(d.getDate() + delta);
          } else if (view === 'week') {
            d.setDate(d.getDate() + delta * 7);
          } else if (view === 'month') {
            d.setMonth(d.getMonth() + delta);
          } else if (view === 'year') {
            d.setFullYear(d.getFullYear() + delta);
          }
          return d;
        });
      }

      let title = '';
      if (view === 'day') {
        title = date.toDateString();
      } else if (view === 'week') {
        const start = new Date(date);
        start.setDate(start.getDate() - start.getDay());
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        title = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
      } else if (view === 'month') {
        title = date.toLocaleString('default', { month: 'long', year: 'numeric' });
      } else if (view === 'year') {
        title = String(date.getFullYear());
      }

      let View = CalendarMonth;
      if (view === 'day') View = CalendarDay;
      else if (view === 'week') View = CalendarWeek;
      else if (view === 'year') View = CalendarYear;

      return React.createElement('div', null,
        React.createElement('div', { className: 'toolbar' },
          React.createElement('button', { onClick: () => navigate(-1) }, 'Prev'),
          React.createElement('button', { onClick: () => setDate(currentTime || new Date()) }, 'Today'),
          React.createElement('span', { className: 'spacer' }, title),
          React.createElement('button', { onClick: () => navigate(1) }, 'Next'),
          React.createElement('span', { className: 'spacer' }),
          ['day','week','month','year'].map(v =>
            React.createElement('button', {
              key: v,
              onClick: () => setView(v)
            }, v.charAt(0).toUpperCase() + v.slice(1))
          )
        ),
        React.createElement(View, { events, date, currentTime })
      );
    }

    function CalendarEvents(props) {
      const [events, setEvents] = useState([]);

      useEffect(() => {
        async function load() {
          try {
            const resp = await fetch(props.feedUrl);
            const text = await resp.text();
            setEvents(window.parseICS(text));
          } catch (err) {
            console.error('Failed to load calendar events', err);
          }
        }
        load();
      }, [props.feedUrl]);

      return React.createElement(Calendar, { events });
    }

    function App() {
      return React.createElement('div', null,
        React.createElement('h2', null, 'Calendar'),
        React.createElement(CalendarEvents, {
          feedUrl: 'https://calendar.google.com/calendar/ical/en.usa%23holiday%40group.v.calendar.google.com/public/basic.ics'
        })
      );
    }

    const rootElem = document.getElementById('root');
    ReactDOM.createRoot(rootElem).render(React.createElement(App));
  </script>
</body>
</html>
