<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Household Agenda</title>
  <link rel="stylesheet" href="calendar.css" />
</head>
<body>
  <noscript>This application requires JavaScript.</noscript>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <script>
    const { useState, useEffect } = React;

    function parseICSTime(s) {
      if (!s) return null;
      const m = s.match(/(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?/);
      if (!m) return null;
      const [, y, mo, d, , h = '0', mi = '0', sec = '0'] = m;
      return new Date(Date.UTC(+y, +mo - 1, +d, +h, +mi, +sec));
    }

    function parseICS(text) {
      const events = [];
      const blocks = text.split('BEGIN:VEVENT').slice(1);
      for (const block of blocks) {
        const body = block.split('END:VEVENT')[0];
        const summary = (body.match(/SUMMARY:(.+)/) || [])[1];
        const start = (body.match(/DTSTART(?:;[^:]+)?:([^\n\r]+)/) || [])[1];
        const end = (body.match(/DTEND(?:;[^:]+)?:([^\n\r]+)/) || [])[1];
        if (summary && start) {
          events.push({
            summary: summary.trim(),
            start: start.trim(),
            end: end ? end.trim() : '',
            startDate: parseICSTime(start.trim())
          });
        }
      }
      return events;
    }

    function CalendarMonth({ events }) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();

      const eventsByDay = {};
      events.forEach(ev => {
        if (!ev.startDate) return;
        const key = ev.startDate.toISOString().slice(0, 10);
        if (!eventsByDay[key]) eventsByDay[key] = [];
        eventsByDay[key].push(ev);
      });

      const monthStart = new Date(year, month, 1);
      const monthEnd = new Date(year, month + 1, 0);
      const firstDay = monthStart.getDay();
      const totalCells = Math.ceil((firstDay + monthEnd.getDate()) / 7) * 7;

      const cells = [];
      for (let i = 0; i < totalCells; i++) {
        const date = new Date(year, month, i - firstDay + 1);
        const key = date.toISOString().slice(0, 10);
        const dayEvents = eventsByDay[key] || [];
        cells.push(React.createElement('div', { className: 'cell', key: key },
          React.createElement('div', { className: 'date' }, date.getDate()),
          React.createElement('ul', null,
            dayEvents.map((ev, idx) => React.createElement('li', { key: idx }, ev.summary))
          )
        ));
      }

      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d =>
        React.createElement('div', { className: 'cell header', key: d }, d)
      );

      return React.createElement('div', { className: 'calendar' },
        dayHeaders.concat(cells)
      );
    }

    function CalendarEvents(props) {
      const [events, setEvents] = useState([]);

      useEffect(() => {
        async function load() {
          try {
            const resp = await fetch(props.feedUrl);
            const text = await resp.text();
            setEvents(parseICS(text));
          } catch (err) {
            console.error('Failed to load calendar events', err);
          }
        }
        load();
      }, [props.feedUrl]);

      return React.createElement(CalendarMonth, { events });
    }

    function App() {
      return React.createElement('div', null,
        React.createElement('h2', null, 'Calendar'),
        React.createElement(CalendarEvents, {
          feedUrl: 'https://calendar.google.com/calendar/ical/en.usa%23holiday%40group.v.calendar.google.com/public/basic.ics'
        })
      );
    }

    const rootElem = document.getElementById('root');
    ReactDOM.createRoot(rootElem).render(React.createElement(App));
  </script>
</body>
</html>
